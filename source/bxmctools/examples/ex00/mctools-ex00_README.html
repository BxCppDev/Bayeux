<h1 id="mctools-examplesex00">mctools <code>examples/ex00</code></h1>
<h2 id="introduction">Introduction</h2>
<blockquote>
<ul>
<li><p>Description:</p>
<p>This example illustrates how to use the mctools Geant4 engine (from the <code>mctools_g4</code> library) to simulate monokinetic 1 MeV eletrons emitted from a source and track them in a virtual geometry.</p>
<p>It is first shown how to use the <code>geomtools_inspector</code> utility to visualize the setup and generate a GDML file usable by Geant4 and browsable by ROOT.</p>
<p>The event and vertex generators are also tested in a standalone mode thanks to the <code>genbb_inspector</code> and <code>genvtx_production</code> programs respectively.</p>
<p>The <code>g4_production</code> program is used to run a Geant4 based Monte-Carlo simulation and produce an output simulated data file both in interactive mode with Geant4 visualization and non-interactive mode.</p>
<p>A sample program is provided to print and display the output simulated data file which contains plain object records of the <code>mctools::simulated_data</code> class.</p>
<p>Finally the <code>dpp_processing</code> program is used to run the Geant4 simulation through a data processing pipeline, using the dedicated data processing module class <code>mctools::g4::simulation_module</code>.</p></li>
<li><p>Source files :</p>
<ul>
<li><p><code>ex00_inspector.h</code> and <code>ex00_inspector.cc</code> : the simulated data inspector class.</p></li>
<li><p><code>ex00_read_plain_simdata.cxx</code> : the program to browse plain simulated data archive files as generated by the <code>g4_production</code> program.</p></li>
<li><p><code>ex00_read_pipeline_simdata.cxx</code> : the program to browse simulated data archive files as generated by the <code>dpp_processing</code> program.</p></li>
</ul></li>
<li><p>Configuration files :</p>
<ul>
<li><p>Geometry :</p>
<ul>
<li><code>config/geometry/manager.conf</code> : the main configuration file of the geometry manager.</li>
<li><p>Geometry models files:</p>
<ul>
<li><code>config/geometry/world.geom</code> : the geometry model that represents the top volume (<em>world</em>).</li>
<li><code>config/geometry/lab.geom</code> : the geometry model that represents the experimental area where the setup is installed and additional geometry volumes.</li>
<li><code>config/geometry/optical_module.geom</code>: the geometry models that represent the detection module (<em>sensitive</em> volume).</li>
<li><code>config/geometry/source.geom</code> : the geometry models that represent the calibration source.</li>
</ul></li>
<li><code>config/geometry/categories.lis</code> : the file that defines the list of <em>geometry categories</em> used to assign <em>geometry IDs</em> to the volumes in the hierarchy.</li>
<li><p>Geometry plugins:</p>
<ul>
<li><code>config/geometry/materials_plugin.conf</code> : the file that defines the <em>materials</em> plugin. At least one material plugin must be provided to export the geometry hierarchy in a GDML file.</li>
<li><p><code>config/geometry/magnetic_field_plugin.conf</code> : the file that defines the <em>electro magnetic fields</em> plugin. One such plugin is provided, it relies on the following files:</p>
<ul>
<li><code>config/geometry/magnetic_field_manager.conf</code> : the main configuration file for the electromagnetic field manager.</li>
<li><code>config/geometry/magnetic_fields.conf</code> : the definitions of the magnetic field modelized in this setup.</li>
</ul></li>
</ul></li>
</ul></li>
<li><p>Event generation:</p>
<ul>
<li><code>config/event_generator/manager.conf</code> : The main configuration file for the event generator manager (<code>genbb::manager</code> class).</li>
<li><code>config/event_generator/guns.conf</code> : The definitions of some event generators.</li>
<li><code>config/event_generator/electron_spectrum_0.data</code> : Data file which contains the tabulated energy spectrum used by an electron generator.</li>
</ul></li>
<li><p>Vertex generation:</p>
<ul>
<li><code>config/vertex_generator/manager.conf</code> : The main configuration file for the vertex generator manager (<code>genvtx::manager</code> class).</li>
<li><code>config/vertex_generator/vertex_generators.conf</code> : The definitions of some vertex generators.</li>
</ul></li>
<li><p>Geant4 simulation:</p>
<ul>
<li><p>Plain simulation (<code>g4_processing</code>):</p>
<ul>
<li><code>config/g4_manager.conf</code> : The main configuration file for the Geant4 simulation engine.</li>
<li><code>config/step_hit_processor_factory.conf</code> : The definitions of the <em>step MC hit processors</em> associated to the sensitive detectors in the geometry.</li>
<li><code>config/g4vis.mac</code> : A sample Geant4 visualization macro (for interactive mode only).</li>
</ul></li>
<li><p>Simulation through the data processing pipeline (<code>dpp_processing</code>):</p>
<ul>
<li><code>config/pipeline/dlls.conf</code> : the list of shared libraries to be dynamically loaded.</li>
<li><code>config/pipeline/module_manager.conf</code> : the main configuration file of the <em>data processing module manager</em> embeded in the <code>dpp_processing</code> program.</li>
<li><code>config/pipeline/service_manager.conf</code> : the main configuration of the <em>service manager</em> embeded in the <code>dpp_processing</code>program and used by the <em>module manager</em>.</li>
<li><code>config/pipeline/services.conf</code> : the definitions of the <em>services</em> used by the <em>data processing modules</em>. Here we define the <em>Geometry service</em> which wraps the <em>geometry manager</em> initialized from the <code>config/geometry/manager.conf</code> file (see above).</li>
<li><code>config/pipeline/modules.conf</code> : the definitions of the <em>data processing modules</em> used along the pipeline Here we use only one <em>simulation module</em> which wraps the <em>Geant4 simulation manager</em> initialized from the <code>config/pipeline/g4_manager.conf</code> file (see below).</li>
<li><code>config/pipeline/g4_manager.conf</code> : The main configuration file for the <em>Geant4 simulation manager</em> used through the pipeline.</li>
</ul></li>
</ul></li>
</ul></li>
<li><p>Built objects :</p>
<blockquote>
<ul>
<li><code>lib/libmctools_ex00.so</code> : the dedicated shared library for this example.</li>
<li><code>ex00_read_plain_simdata</code> : the executable linked against the <code>mctools_ex00</code> library and other Bayeux libraries (<code>mctools_g4</code>, <code>datatools_bio</code>, <code>geomtools_bio</code> and <code>mctools_bio</code>). It enables the reading of simulated data objects generated by the <code>g4_production</code> program, print them and displays Gnuplot based 3D view.</li>
<li><code>ex00_read_pipeline_simdata</code> : the executable linked against the <code>mctools_ex00</code> library and other Bayeux libraries (<code>mctools_g4</code>, <code>datatools_bio</code>, <code>geomtools_bio</code> and <code>mctools_bio</code>). It enables the reading of simulated data objects generated by the <code>dpp_processing</code> program (data processing pipeline with an embedded Geant4 simulation processing module), print them and displays Gnuplot based 3D view.</li>
</ul>
</blockquote></li>
<li><p>Build method: CMake.</p></li>
</ul>
</blockquote>
<h2 id="quick-start">Quick start</h2>
<ol style="list-style-type: decimal">
<li>Build, install and setup the <code>mctools</code> library.</li>
<li><p>Make a copy of the example directory:</p>
<pre><code>shell&gt; cp -a [mctools install base directory]/share/mctools/examples/ex00 /tmp/ex00
shell&gt; cd /tmp/ex00</code></pre></li>
<li><p>Build and install the example program:</p>
<pre><code>shell&gt; mkdir __build
shell&gt; cd __build
shell&gt; cmake \
  -DCMAKE_INSTALL_PREFIX=.. \
  -Dmctools_DIR=$(mctools-config --prefix) \
  ..
shell&gt; make
shell&gt; make install
shell&gt; cd ..</code></pre></li>
<li><p>Standalone Geometry:</p>
<p>a. Run the <code>geomtools_inspector</code> to check the virtual geometry:</p>
<pre><code>shell&gt; geomtools_inspector \
         --load-dll emfield \
         --manager-config config/geometry/manager.conf \
         --with-visu --visu-view-3d
geomtools&gt; help
geomtools&gt; display -3d world
geomtools&gt; display [1000:0]
geomtools&gt; display [2020:0.0]</code></pre>
<blockquote>
<p>geomtools&gt; quit</p>
<blockquote>
<p>Note: here we load the <code>emfield</code> library because the geometry setup depends on a plugin dedicated to the modelization of electromagnetic fields provided by the <code>emfield</code> library.</p>
<p>It displays views of the setup using the <code>geomtools</code> Gnuplot viewer.</p>
<img src="images/ex00_geometry_1.jpg" alt="The 3D view of the setup (file ``images/ex00_geometry_1.jpg``)" />
<img src="images/ex00_geometry_2.jpg" alt="The 2D view of the setup (file ``images/ex00_geometry_2.jpg``)" />
</blockquote>
</blockquote>
<ol start="2" style="list-style-type: lower-alpha">
<li><p>ROOT display of the setup via the <code>mctools_ex00-1.0.gdml</code> GDML file</p>
<pre><code>shell&gt; root
root [0] TGeoManager * geo = new TGeoManager(&quot;geo&quot;,&quot;mctools examples/ex00 virtual setup&quot;);
root [1] TGeoManager * g2 = geo-&gt;Import(&quot;mctools_ex00-1.0.gdml&quot;);
root [2] g2-&gt;SetVisOption(0);
root [3] g2-&gt;SetVisLevel(100);
root [4] g2-&gt;GetMasterVolume()-&gt;Draw(&quot;&quot;);
root [5] .q</code></pre>
<p>It displays a 3D view of the setup using the ROOT visualization tool.</p>
<img src="images/ex00_geometry_3.jpg" alt="The OpenGL 3D view of the setup from ROOT (file ``images/ex00_geometry_3.jpg``)" /></li>
</ol></li>
<li><p>Standalone event generation:</p>
<blockquote>
<ol style="list-style-type: lower-alpha">
<li><p>Show the list of available generators:</p>
<pre><code>shell&gt; genbb_inspector \
         --configuration &quot;config/event_generator/manager.conf&quot; \
         --action &quot;list&quot;
List of particle generators: :
|-- electron_1MeV                  : genbb::single_particle_generator (not initialized)
|-- electron_1MeV_cone             : genbb::single_particle_generator (not initialized)
|-- electron_1MeV_gaussian_100keV  : genbb::single_particle_generator (not initialized)
|-- electron_2MeV                  : genbb::single_particle_generator (not initialized)
|-- electron_3MeV                  : genbb::single_particle_generator (not initialized)
|-- electron_50-2000keV_flat       : genbb::single_particle_generator (not initialized)
`-- electron_pdf                   : genbb::single_particle_generator (not initialized)</code></pre></li>
<li><p>Shoot some primary events from one event generator:</p>
<pre><code>shell&gt; genbb_inspector \
         --configuration &quot;config/event_generator/manager.conf&quot; \
         --action &quot;shoot&quot; \
         --generator &quot;electron_1MeV_gaussian_100keV&quot; \
         --prng-seed 314159 \
         --number-of-events 10000 \
         --output-file &quot;histos_electron_1MeV_gaussian_100keV.root&quot;</code></pre></li>
<li><p>Display histograms associated to the event kinematics:</p>
<pre><code>shell&gt; root histos_electron_1MeV_gaussian_100keV.root
root [1] TBrowser b; // then use the GUI to display the histograms
root [2] .q</code></pre>
<p>It displays some histograms related to the kinematics of the 2MeV electrons.</p>
<img src="images/ex00_genbb_electron_1MeV_gaussian_100keV_prompt_electron_0_energy.jpg" alt="The first prompt electron energy spectrum in the ^60^Co decay (file ``images/ex00_genbb_electron_1MeV_gaussian_100keV_prompt_electron_0_energy.jpg``)" /></li>
</ol>
</blockquote></li>
<li><p>Standalone vertex generation:</p>
<blockquote>
<ol style="list-style-type: lower-alpha">
<li><p>Show the list of available generators:</p>
<pre><code>shell&gt; genvtx_production \
        --geometry-manager &quot;config/geometry/manager.conf&quot; \
        --vertex-generator-manager &quot;config/vertex_generator/manager.conf&quot; \
        --list
List of vertex generators :
|-- lab_all_walls.vg  : Vertex generation from the surface of the experimental hall
|-- lab_roof.vg  : Vertex generation from the surface of the experimental hall&#39;s roof
|-- scin_bulk.vg  : Vertex generation from the bulk of the scintillator blocks
|-- scin_bulk_deep.vg  : Vertex generation from the bulk of the scintillator blocks
|-- scin_surface.vg  : Vertex generation from the surface of the scintillator blocks
|-- scin_wrapping_all_bulk.vg  : Vertex generation from the bulk of scintillator block wrapping films (all sides)
|-- scin_wrapping_front_back_bulk.vg  : Vertex generation from the bulk of scintillator block wrapping films (front and back sides)
|-- scin_wrapping_left_right_bulk.vg  : Vertex generation from the bulk of scintillator blocks wrapping films (left and right sides)
|-- scin_wrapping_top_bulk.vg  : Vertex generation from the bulk of scintillator block wrapping film (only top side)
|-- source_bulk.vg (current) : Vertex generation from the source bulk
|-- source_support_bulk.vg  : Vertex generation from the source bulk
`-- source_surface.vg  : Vertex generation from the source bulk</code></pre></li>
<li><p>Shoot some random vertex generators and visualize them:</p>
<pre><code>shell&gt; genvtx_production \
        --load-dll emfield  \
        --geometry-manager &quot;config/geometry/manager.conf&quot; \
        --vertex-generator-manager &quot;config/vertex_generator/manager.conf&quot; \
        --shoot \
        --number-of-vertices 400 \
        --prng-seed 314159 \
        --vertex-generator &quot;source_bulk.vg&quot; \
        --output-file &quot;mctools_ex00_vertices.txt&quot; \
        --visu --tiny</code></pre></li>
</ol>
<blockquote>
<p>It displays a 3D view of the setup with the positions of the generated vertexes from the bulk of the source film.</p>
<img src="images/ex00_vertex_generator_source_bulk.jpg" alt="The generated vertexes from the bulk of the source film (file ``images/ex00_vertex_generator_source_bulk.jpg``)" />
</blockquote>
<ol start="3" style="list-style-type: lower-alpha">
<li><p>Another random vertex generators:</p>
<pre><code>shell&gt; genvtx_production \
        --load-dll emfield  \
        --geometry-manager &quot;config/geometry/manager.conf&quot; \
        --vertex-generator-manager &quot;config/vertex_generator/manager.conf&quot; \
        --shoot \
        --number-of-vertices 2000 \
        --prng-seed 314159 \
        --vertex-generator &quot;scin_wrapping_all_bulk.vg&quot; \
        --output-file &quot;mctools_ex00_vertices2.txt&quot; \
        --visu --tiny</code></pre></li>
</ol>
<blockquote>
<img src="images/ex00_vertex_generator_scin_wrapping_all_bulk.jpg" alt="The generated vertexes from the bulk of the scintillator wrapping film (file ``images/ex00_vertex_generator_scin_wrapping_all_bulk.jpg``)" />
</blockquote>
</blockquote></li>
<li><p>Geant4 simulation:</p>
<blockquote>
<ol style="list-style-type: lower-alpha">
<li><p>Run the simulation through a Geant4 interactive session with visualization:</p>
<pre><code>shell&gt; g4_production \
       --logging-priority &quot;warning&quot; \
       --number-of-events-modulo 1 \
       --interactive \
       --g4-visu \
       --config &quot;config/g4_manager.conf&quot; \
       --vertex-generator-name &quot;source_bulk.vg&quot; \
       --vertex-generator-seed 0 \
       --event-generator-name &quot;electron_1MeV_cone&quot; \
       --event-generator-seed 0 \
       --shpf-seed 0 \
       --g4-manager-seed 0 \
       --output-prng-seeds-file &quot;prng_seeds.save&quot; \
       --output-prng-states-file &quot;prng_states.save&quot; \
       --output-data-file &quot;mctools_ex00_electron_1MeV_source_bulk.xml&quot; \
       --g4-macro &quot;config/g4vis.mac&quot;</code></pre></li>
</ol>
<blockquote>
<p>From the Geant4 interactive session:</p>
<pre><code>Idle&gt; /vis/viewer/set/viewpointThetaPhi -60 45
Idle&gt; /run/beamOn 10
Idle&gt; exit</code></pre>
<p>It displays the virtual geometry setup using the Geant4 visualization driver.</p>
<img src="images/ex00_g4_production_0.jpg" alt="The Geant4 visualization of the geometry (file ``images/ex00_g4_production_0.jpg``)" />
<img src="images/ex00_g4_production_1.jpg" alt="The Geant4 visualization of a 1MeV electron emitted from the source film and backscatterred on the absorber foil (file ``images/ex00_g4_production_1.jpg``)" />
<img src="images/ex00_g4_production_2.jpg" alt="The Geant4 visualization of a 1MeV electron emitted from the source film and stopped in the scintillator block (file ``images/ex00_g4_production_2.jpg``)" />
<img src="images/ex00_g4_production_3.jpg" alt="The Geant4 visualization of many 1MeV electrons emitted from the source film (file ``images/ex00_g4_production_3.jpg``)" />
<p>Then browse the output plain simulated data file</p>
<pre><code>shell&gt; ls -l mctools_ex00_electron_1MeV_source_bulk.xml
shell&gt; export LD_LIBRARY_PATH=./lib:${LD_LIBRARY_PATH}
shell&gt; ./ex00_read_plain_simdata \
        --load-dll emfield  \
        --logging-priority &quot;notice&quot; \
        --interactive \
        --with-visualization \
        --input-file &quot;mctools_ex00_electron_1MeV_source_bulk.xml&quot;</code></pre>
<img src="images/ex00_g4_production_4.jpg" alt="The geomtools 3D visualization of a recorded simulated event (file ``images/ex00_g4_production_4.jpg``)" />
<img src="images/ex00_g4_production_5.jpg" alt="The geomtools 3D visualization of a recorded simulated event with an electron stopped in the scintillator block after scattering the absorber foil (file ``images/ex00_g4_production_5.jpg``)" />
<img src="images/ex00_g4_production_6.jpg" alt="The geomtools XZ-visualization of a recorded simulated event with an electron stopped in the scintillator block after scattering the absorber foil (file ``images/ex00_g4_production_6.jpg``)" />
<img src="images/ex00_g4_production_7.jpg" alt="Detailed XZ-view of the electron hit in the scintillator block with superimposed electron track (file ``images/ex00_g4_production_7.jpg``)" />
</blockquote>
<ol start="2" style="list-style-type: lower-alpha">
<li><p>Run the simulation in non-interactive mode:</p>
<pre><code>shell&gt; g4_production \
       --logging-priority &quot;warning&quot; \
       --number-of-events 100 \
       --number-of-events-modulo 0 \
       --batch \
       --config &quot;config/g4_manager.conf&quot; \
       --vertex-generator-name &quot;source_bulk.vg&quot; \
       --vertex-generator-seed 0 \
       --event-generator-name &quot;electron_1MeV&quot; \
       --event-generator-seed 0 \
       --shpf-seed 0 \
       --g4-manager-seed 0 \
       --output-prng-seeds-file &quot;prng_seeds.save&quot; \
       --output-prng-states-file &quot;prng_states.save&quot; \
       --output-data-file &quot;mctools_ex00_electron_1MeV_source_bulk.data.gz&quot;</code></pre>
<p>Then browse the output plain simulated data file</p>
<pre><code>shell&gt; ls -l mctools_ex00_electron_1MeV_source_bulk.data.gz
shell&gt; ./ex00_read_plain_simdata \
        --load-dll emfield  \
        --logging-priority &quot;notice&quot; \
        --interactive \
--with-visualization \
        --input-file &quot;mctools_ex00_electron_1MeV_source_bulk.data.gz&quot;</code></pre></li>
</ol>
<blockquote>
<img src="images/ex00_g4_production_8.jpg" alt="Detailed YZ-view of an electron absorbed in the source support (file ``images/ex00_g4_production_8.jpg``)" />
</blockquote>
<ol start="3" style="list-style-type: lower-alpha">
<li><p>Run the geant4 simulation through the data processing pipeline:</p>
<pre><code>shell&gt; dpp_processing \
 --logging-priority &quot;notice&quot; \
 --dlls-config &quot;config/pipeline/dlls.conf&quot; \
 --module-manager-config &quot;config/pipeline/module_manager.conf&quot; \
 --max-records 1000 \
 --modulo 100 \
 --module &quot;electron_1MeV_cone@source_bulk&quot; \
 --output-file &quot;mctools_ex00_electron_1MeV@source_bulk.dpp.xml&quot;</code></pre>
<p>The output data file use the Boost XML archive format and stores the simulated data within <code>datatools::things</code> object records:</p>
<pre><code>shell&gt; ls -l mctools_ex00_electron_1MeV_cone@source_bulk.dpp.xml
shell&gt; ./ex00_read_pipeline_simdata \
        --load-dll emfield  \
        --logging-priority &quot;notice&quot; \
        --interactive \
--with-visualization \
        --input-file &quot;mctools_ex00_electron_1MeV_cone@source_bulk.dpp.xml&quot;</code></pre></li>
</ol>
<blockquote>
<img src="images/ex00_g4_pipeline_2.jpg" alt="The 3D-view of the simulated electron track with a scintillator hit (file ``images/ex00_g4_pipeline_2.jpg``)" />
<img src="images/ex00_g4_pipeline_0.jpg" alt="The print of the simulated data bank (file ``images/ex00_g4_pipeline_0.jpg``)" />
<img src="images/ex00_g4_pipeline_1.jpg" alt="The print of the scintillator hit (file ``images/ex00_g4_pipeline_0.jpg``)" />
</blockquote>
</blockquote></li>
<li><p>Clean:</p>
<pre><code>shell&gt; rm mctools_ex00_electron_1MeV_cone@source_bulk.dpp.xml
shell&gt; rm prng_seeds.save
shell&gt; rm prng_seeds.save.~backup~
shell&gt; rm mctools_ex00_electron_1MeV_source_bulk.data.gz
shell&gt; rm mctools_ex00_electron_1MeV_source_bulk.xml
shell&gt; rm mctools_ex00_vertices2.txt
shell&gt; rm mctools_ex00_vertices.txt
shell&gt; rm histos_electron_1MeV_gaussian_100keV.root
shell&gt; rm ex00_read_plain_simdata
shell&gt; rm mctools_ex00-1.0.gdml
shell&gt; rm geomtools_inspector.C
shell&gt; rm -fr lib/
shell&gt; rm -fr __build/</code></pre></li>
</ol>
