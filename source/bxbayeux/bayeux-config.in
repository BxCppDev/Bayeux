#!/usr/bin/env bash
# bayeux-config
# Author: F. Mauger <mauger@lpccaen.in2p3.fr>
#
# This script should not be used to compile and link applications
# with Bayeux support. CMake must be used for that. This script is
# provided only as an utility tools to help the localization of Bayeux
# system components (headers, DLL, resource files...).
#

script_name="bayeux-config"
opwd=$(pwd)
help=0
debug=0
devel=0

function my_exit()
{
    cd ${opwd}
    exit $1
}

bayeux_system="@CMAKE_SYSTEM_NAME@-@CMAKE_SYSTEM_PROCESSOR@"

bayeux_root="@CMAKE_INSTALL_PREFIX@"
# Future: support for relocatable Bayeux:
# which realpath > /dev/null 2>&1
# if [ $? -eq 0 ]; then
#     bayeux_root="$(realpath $0)"
#     ...
# fi

bayeux_bin_dir="${bayeux_root}/bin"

bayeux_include_dir="${bayeux_root}/include"

bayeux_lib_dir="${bayeux_root}/lib"

bayeux_cmake_config_dir="${bayeux_root}/lib/cmake/Bayeux-@Bayeux_VERSION@"

bayeux_data_dir="${bayeux_root}/@CMAKE_INSTALL_DATAROOTDIR@"

bayeux_materials_data_dir="${bayeux_root}/@CMAKE_INSTALL_DATAROOTDIR@/materials/resources"

bayeux_genbb_help_data_dir="${bayeux_root}/@CMAKE_INSTALL_DATAROOTDIR@/genbb_help/resources"

bayeux_geomtools_data_dir="${bayeux_root}/@CMAKE_INSTALL_DATAROOTDIR@/geomtools/resources"

bayeux_doc_dir="${bayeux_root}/@CMAKE_INSTALL_DATAROOTDIR@/Documentation"

bayeux_version="@Bayeux_VERSION@"

bayeux_submodules="@Bayeux_SUBMODULES@"

bayeux_has_geant4=@Bayeux_WITH_GEANT4@

bayeux_enable_testing=@Bayeux_ENABLE_TESTING@

bayeux_addons="@Bayeux_ADDON_TARGETS@"

bayeux_boost_inc_dir="@Boost_INCLUDE_DIRS@"
bayeux_boost_lib_dir=`echo ${bayeux_boost_inc_dir} | sed -e 's%/include%/lib%g'`
bayeux_boost_libs="@Boost_LIBRARIES@"

bayeux_camp_inc_dir="@CAMP_INCLUDE_DIRS@"
bayeux_camp_lib_dir=`echo ${bayeux_camp_inc_dir}   | sed -e 's%/include%/lib%g'`
bayeux_camp_libs="@CAMP_LIBRARIES@"

bayeux_clhep_inc_dir="@CLHEP_INCLUDE_DIRS@"

bayeux_gsl_inc_dir="@GSL_INCLUDE_DIRS@"

bayeux_root_inc_dir="@ROOT_INCLUDE_DIRS@"

# XercesC trick:
##bayeux_xercesc_inc_dir="@XERCESC_INCLUDE_DIRS@"
bayeux_xercesc_bin_dir="`dirname $(which SAXCount)`"
bayeux_xercesc_inc_dir=`echo ${bayeux_xercesc_bin_dir}   | sed -e 's%/bin%/include%g'`
bayeux_xercesc_lib_dir=`echo ${bayeux_xercesc_bin_dir}   | sed -e 's%/bin%/lib%g'`
bayeux_xercesc_libs="xerces-c"

option="$1"
shift 1

if [ "x${option}" = "x--devel" ]; then
    # Devel mode
    devel=1
    option="$1"
fi

function print_help ()
{
    cat<<EOF
Usage: ${script_name} [OPTION]

Supported values for OPTION are:

  --help                print this help then exit
  --version             print version information
  --system              print system
  --prefix              print Bayeux installation prefix
  --bindir              print binary directory
  --libdir              print library directory
  --incdir              print include directory
  --datadir             print data/resources base directory
  --datadir@{module}    print data/resources base directory for module
                        named {module}.
                        Supported modules are:
                         - materials
                         - geomtools
                         - genbb_help
  --docdir              print documentation base directory
  --cmake-config-dir    print the installation directory for the 'BayeuxConfig.cmake' file
  --devel               switch to special devel mode (first switch on the command line)
EOF

if [ $devel -eq 1 ]; then
    cat<<EOF

Special options for developpers (not recommended):

  --include             print include path pre-processor flags without dependencies
  --cflags              print include path pre-processor flags with dependencies
  --libs    [option]    print library linking information, without dependencies
  --ldflags [option]
    Options:
    --relative-path     use relative DLL path (default)
    --absolute-path     use absolute DLL path
    --with-geant4       use the Geant4 shared library addon
EOF
fi

    cat<<EOF

Examples:

   Print the Bayeux's installation prefix:
    \$ ${script_name} --prefix

   Print the versions of all Bayeux's modules:
   \$ find \$(${script_name} --incdir)/bayeux -name version.h -exec grep _LIB_VERSION \{\} \; | cut -d' ' -f 2-3 | tr ' ' '=' | tr -d '"'

EOF
    return 0
}

if [ "x${option}" = "x" ]; then
    echo "ERROR: ${script_name}: Missing option ! Abort !" 1>&2
    help=1
fi

if [ "x${option}" = "x--help" -o "x${option}" = "x-h" -o "x${option}" = "x-?" ]; then
    help=1
fi

if [ ${help} -eq 1 ]; then
    print_help
    my_exit 1
fi

if [ "x${option}" = "x--version" ]; then
    echo "${bayeux_version}"
    my_exit 0
fi

if [ "x${option}" = "x--system" ]; then
    echo "${bayeux_system}"
    my_exit 0
fi

if [ "x${option}" = "x--prefix" ]; then
    echo "${bayeux_root}"
    my_exit 0
fi

if [ "x${option}" = "x--version" ]; then
    echo "${bayeux_version}"
    my_exit 0
fi

if [ "x${option}" = "x--bindir" ]; then
    echo "${bayeux_bin_dir}"
    my_exit 0
fi

if [ "x${option}" = "x--libdir" ]; then
    echo "${bayeux_lib_dir}"
    my_exit 0
fi

if [ "x${option}" = "x--incdir" ]; then
    echo "${bayeux_include_dir}"
    my_exit 0
fi

if [ "x${option}" = "x--datadir" ]; then
    echo "${bayeux_data_dir}"
    my_exit 0
fi

if [ "x${option}" = "x--datadir@materials" ]; then
    echo "${bayeux_materials_data_dir}"
    my_exit 0
fi

if [ "x${option}" = "x--datadir@geomtools" ]; then
    echo "${bayeux_geomtools_data_dir}"
    my_exit 0
fi

if [ "x${option}" = "x--datadir@genbb_help" ]; then
    echo "${bayeux_genbb_help_data_dir}"
    my_exit 0
fi

if [ "x${option}" = "x--docdir" ]; then
    echo "${bayeux_doc_dir}"
    my_exit 0
fi

if [ "x${option}" = "x--cmake-config-dir" ]; then
    echo "${bayeux_cmake_config_dir}"
    my_exit 0
fi

if [ $devel -eq 1 ]; then
if [ "x${option}" = "x--include" ]; then
    echo -n "-I${bayeux_include_dir}  "
    echo -n "-I${bayeux_include_dir}/bayeux "
    echo
    my_exit 0
fi

if [ "x${option}" = "x--cflags" ]; then
    (
	echo -n "-I${bayeux_include_dir} -I${bayeux_include_dir}/bayeux "
	if [ ${bayeux_has_geant4} -ne 0 ]; then
	    echo -n "`geant4-config --cflags  | tr -d '\"' `"
	    echo -n " -I${bayeux_xercesc_inc_dir} "
	fi
	echo -n " `root-config --cflags` "
	echo -n " `gsl-config --cflags` "
	echo -n " $(clhep-config --include | tr -d '\"') "
	echo -n " -I${bayeux_camp_inc_dir} "
	echo -n " -I${bayeux_boost_inc_dir} "
	echo
    ) | tr [[:space:]] ' ' | tr -s ' '  | tr ' ' '\n' | awk '!x[$0]++' | tr  '\n' ' '
    echo
    my_exit 0
fi

which tac > /dev/null 2>&1
if [ $? -ne 0 ]; then
    echo "ERROR: ${script_name}: tac (from coreutils) is not installed !" 1>&2
    my_exit 1
fi
ldflags_abs_path=0
libbayeux_with_geant4=0

if [ "x${option}" = "x--libs" -o "x${option}" = "x--ldflags" ]; then
    while [ -n "$1" ]; do
	lib_option="$1"
	if [ "x${lib_option}" = "x--absolute-path" ]; then
	    ldflags_abs_path=1
	elif [ "x${lib_option}" = "x--relative-path" ]; then
	    ldflags_abs_path=0
	elif [ "x${lib_option}" = "x--with-geant4" ]; then
	    if [ ${bayeux_has_geant4} -eq 0 ]; then
		echo "ERROR: ${script_name}: Bayeux is not built with Geant4 support !" 1>&2
		my_exit 1
	    fi
	    libbayeux_with_geant4=1
	fi
	shift 1
    done
fi

if [ "x${option}" = "x--libs" ]; then
    if [ ${ldflags_abs_path} -eq 1 ]; then
	if [ ${bayeux_has_geant4} -ne 0 -a ${libbayeux_with_geant4} -eq 1 ]; then
	    echo -n "${bayeux_lib_dir}/libBayeux_mctools_geant4@CMAKE_SHARED_LIBRARY_SUFFIX@ "
	fi
	echo -n "${bayeux_lib_dir}/libBayeux@CMAKE_SHARED_LIBRARY_SUFFIX@ "
    else
	echo -n "-L${bayeux_lib_dir} "
	if [ ${bayeux_has_geant4} -ne 0 -a ${libbayeux_with_geant4} -eq 1 ]; then
	    echo -n "-lBayeux_mctools_geant4 "
	fi
	echo -n "-lBayeux "
    fi
    echo
    my_exit 0
fi

if [ "x${option}" = "x--ldflags" ]; then
    (
	if [ ${ldflags_abs_path} -eq 1 ]; then
	    if [ $libbayeux_with_geant4 -eq 1 ]; then
		echo -n "${bayeux_lib_dir}/libBayeux_mctools_geant4@CMAKE_SHARED_LIBRARY_SUFFIX@ "
	    fi
	    echo -n "${bayeux_lib_dir}/libBayeux@CMAKE_SHARED_LIBRARY_SUFFIX@ "

	else
	    echo -n "-L${bayeux_lib_dir} "
	    if [ ${bayeux_has_geant4} -ne 0 -a ${libbayeux_with_geant4} -eq 1 ]; then
		echo -n "-lBayeux_mctools_geant4 "
	    fi
	    echo -n "-lBayeux "
	fi
	if [ ${bayeux_has_geant4} -ne 0  -a ${libbayeux_with_geant4} -ne 0 ]; then
	    echo -n " `geant4-config --libs   | tr -d '\"' ` "
	    echo -n " -L${bayeux_xercesc_lib_dir} -l${bayeux_xercesc_libs} "
	fi
	echo -n " `root-config --libs` "
	echo -n " -L${bayeux_camp_lib_dir} -lcamp "
	echo -n " -L${bayeux_boost_lib_dir} "
	_boost_libs=$(echo ${bayeux_boost_libs} | tr ';' ' ')
	for boost_lib_entry in ${_boost_libs}; do
	    boost_lib1=`ls -1 ${bayeux_boost_lib_dir}/libboost_*@CMAKE_SHARED_LIBRARY_SUFFIX@ | grep /lib${boost_lib_entry} `
	    if [ "x${boost_lib1}" != "x" ]; then
		for _bl in ${boost_lib1} ; do
		    boost_lib=`basename ${_bl} | sed -e 's%lib%%g' -e 's%@CMAKE_SHARED_LIBRARY_SUFFIX@$%%g' `
		    echo -n " -l${boost_lib} "
		done
	    fi
	done
	echo -n " $(clhep-config --libs | tr -d '\"' ) "
	echo -n " `gsl-config --libs` "
    ) | tr [[:space:]] ' ' | tr -s ' '  | tr ' ' '\n' | tac | awk '!x[$0]++' | tac | tr  '\n' ' '

    echo
    my_exit 0
fi

fi

if [ "x${option}" = "x--has-geant4" ]; then
    echo "${bayeux_has_geant4}"
    if [ ${bayeux_has_geant4} -eq 1 ]; then
	my_exit 0
    else
	my_exit 1
    fi
fi

echo "ERROR: ${script_name}: Unknown option '${option}' !" 1>&2
print_help
my_exit 1

# end of bayeux-config
